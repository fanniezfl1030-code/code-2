<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Voice Reactor Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght,soft,WONK@9..144,100..900,0..100,0..1&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: #00f2ff; 
            --bg: #050505; 
            --panel: #1a1a1a;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            background: var(--bg); 
            color: white; 
            font-family: 'Fraunces', system-ui, sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100dvh; /* 使用 dvh 解决移动端地址栏遮挡问题 */
            overflow: hidden; 
        }
        
        /* 顶部控制栏 - 针对手机优化布局 */
        .header { 
            padding: 15px; 
            background: rgba(17, 17, 17, 0.9); 
            backdrop-filter: blur(10px);
            display: grid; 
            grid-template-columns: 1fr 1fr; /* 双列布局 */
            gap: 10px;
            border-bottom: 1px solid #222; 
            z-index: 100;
            flex-shrink: 0;
        }

        .btn { 
            background: #222; 
            color: var(--accent); 
            border: 1px solid #333; 
            padding: 12px 0; /* 增大触控高度 */
            border-radius: 8px; 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 14px; 
            text-transform: uppercase;
            text-align: center;
            transition: all 0.2s;
            width: 100%;
        }

        .btn.active {
            background: var(--accent);
            color: black;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
        }

        /* 隐藏原生文件输入框，使用 Label 模拟按钮 */
        #fileInput { display: none; }
        .file-btn {
            display: flex; align-items: center; justify-content: center;
            background: #222; color: #888; border: 1px solid #333;
            border-radius: 8px; font-size: 12px; font-weight: bold;
        }

        /* 主舞台区域 */
        .stage { 
            flex: 1; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            position: relative; 
            width: 100%;
            overflow: hidden;
        }
        
        /* 文本输入区 - 允许在手机上换行，字体自适应 */
        #output-text {
            width: 100%; 
            height: 100%;
            padding: 20px;
            background: none; 
            border: none; 
            color: white; 
            text-align: center;
            /* 移动端字体调整：使用视口单位 vw */
            font-size: clamp(40px, 18vw, 120px); 
            outline: none; 
            resize: none; 
            z-index: 10;
            
            /* 垂直居中 */
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* 字体设置 */
            font-variation-settings: 'wght' 100, 'SOFT' 0, 'opsz' 72;
            transition: font-variation-settings 0.05s linear; /* 更快的响应速度 */
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.15);
        }

        /* 画布 - 铺满底部或作为背景 */
        #viz-canvas {
            position: absolute; 
            bottom: 0; 
            left: 0;
            width: 100%; 
            height: 40%; /* 占据下半部分 */
            pointer-events: none;
            z-index: 5;
            mask-image: linear-gradient(to top, black 20%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, black 20%, transparent 100%);
        }

        /* 数据监控 - 移到底部角落，避免遮挡手指 */
        .data-monitor {
            position: absolute; 
            top: 20px; 
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Courier New', monospace; 
            font-size: 10px; 
            color: #666; 
            display: flex;
            gap: 15px;
            pointer-events: none;
            z-index: 20;
        }
        
        .status-pill {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 10px;
            color: var(--accent);
            opacity: 0.5;
            letter-spacing: 2px;
        }

    </style>
</head>
<body>

<div class="header">
    <button class="btn" id="startBtn">启动麦克风</button>
    <label for="fileInput" class="btn file-btn" id="fileLabel">
        加载字体文件
    </label>
    <input type="file" id="fileInput" accept=".ttf,.woff2">
</div>

<div class="stage">
    <div class="data-monitor">
        <span>VOL: <b id="m-vol">0</b></span>
        <span>PIT: <b id="m-pit">0</b></span>
    </div>
    
    <textarea id="output-text" spellcheck="false" inputmode="text">Your Voice</textarea>
    
    <canvas id="viz-canvas"></canvas>
    <div id="status" class="status-pill">READY</div>
</div>

<script>
    let audioCtx, analyser, dataArray;
    let isActive = false;
    const canvas = document.getElementById('viz-canvas');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');

    // 1. 自定义字体处理
    document.getElementById('fileInput').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        // 更新按钮文字提示用户
        document.getElementById('fileLabel').innerText = "加载中...";
        
        const buffer = await file.arrayBuffer();
        // 清理旧字体名称防止冲突
        const fontName = 'DynamicFont_' + Date.now();
        const font = new FontFace(fontName, buffer);
        
        try {
            await font.load();
            document.fonts.add(font);
            document.getElementById('output-text').style.fontFamily = fontName;
            document.getElementById('fileLabel').innerText = "字体已应用";
            document.getElementById('fileLabel').style.color = "var(--accent)";
            statusEl.innerText = "CUSTOM FONT";
        } catch(err) { 
            alert("字体加载失败，请确保是 .ttf 或 .woff2 格式的可变字体"); 
            document.getElementById('fileLabel').innerText = "重试";
        }
    };

    // 2. 音频初始化 (针对移动端触摸事件优化)
    startBtn.onclick = async function() {
        if (!audioCtx) {
            try {
                // 标准与 Webkit 前缀支持
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // 移动端权限请求
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: false,
                        noiseSuppression: false, // 关闭降噪以获得更原始的输入
                        autoGainControl: false 
                    } 
                });
                
                const source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256; 
                analyser.smoothingTimeConstant = 0.5; // 让数值变化更平滑一点
                source.connect(analyser);
                
                isActive = true;
                
                // UI 状态更新
                startBtn.classList.add('active');
                startBtn.innerText = "正在监听";
                statusEl.innerText = "LIVE ACTIVE";
                
                resizeCanvas();
                loop();
            } catch(e) { 
                console.error(e);
                alert("无法访问麦克风。\n\n1. 请检查手机权限设置。\n2. 确保使用 HTTPS 协议访问。\n3. iOS 请在 Safari 中打开。"); 
            }
        } else if (audioCtx.state === 'suspended') {
            await audioCtx.resume();
            isActive = true;
            startBtn.classList.add('active');
        }
    };

    // 3. 高清屏 Canvas 适配
    function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        // 获取 CSS 显示尺寸
        const rect = canvas.getBoundingClientRect();
        
        // 设置实际物理像素
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        
        // 缩放绘图上下文，保证逻辑坐标与 CSS 像素一致
        ctx.scale(dpr, dpr);
    }

    window.addEventListener('resize', resizeCanvas);

    // 4. 核心交互循环
    function loop() {
        if(!isActive) return;
        requestAnimationFrame(loop);
        
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);

        // --- 数据计算 ---
        let total = 0;
        let weightedSum = 0;
        // 简单的重心法计算音高（简化版）
        for(let i=0; i<dataArray.length; i++) {
            total += dataArray[i];
            weightedSum += dataArray[i] * i;
        }
        
        // 数据平滑处理（可选，防止闪烁太快）
        let volume = total / dataArray.length; 
        let pitch = weightedSum / (total || 1); 

        // 放大一点移动端的灵敏度，因为手机麦克风距离较远
        volume = Math.min(volume * 1.2, 255); 

        // --- 字体形变映射 (保持原始逻辑) ---
        const text = document.getElementById('output-text');
        
        // 原始映射逻辑
        let wght = 100 + (volume * 4);
        let soft = Math.min(volume, 100);
        let opsz = 72 + (pitch * 0.5);
        let wdth = 75 + pitch;

        // 限制最大值防止字体崩坏
        wght = Math.min(wght, 900); 
        wdth = Math.min(wdth, 200);

        text.style.fontVariationSettings = `'wght' ${wght}, 'SOFT' ${soft}, 'opsz' ${opsz}, 'wdth' ${wdth}`;
        
        // 更新监控
        document.getElementById('m-vol').innerText = Math.round(volume);
        document.getElementById('m-pit').innerText = Math.round(pitch);

        drawVisualizer();
    }

    function drawVisualizer() {
        // 使用 CSS 尺寸清空画布
        const width = canvas.width / (window.devicePixelRatio || 1);
        const height = canvas.height / (window.devicePixelRatio || 1);
        
        ctx.clearRect(0, 0, width, height);

        const barWidth = (width / dataArray.length) * 1.5;
        let x = 0;

        for (let i = 0; i < dataArray.length; i++) {
            let barHeight = (dataArray[i] / 255) * height;
            
            // 颜色动态变化：增加一些透明度让叠加更好看
            let hue = 180 + (i * 2); 
            ctx.fillStyle = `hsla(${hue}, 100%, 50%, 0.8)`;
            
            // 绘制圆角条形，看起来更现代
            ctx.fillRect(x, height - barHeight, barWidth - 1, barHeight);
            x += barWidth;
        }
    }
</script>
</body>
</html>